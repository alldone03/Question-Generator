version: "3.9"

services:
  # MySQL Database
  db:
    image: mysql:8.0
    container_name: itsquizz-db
    restart: unless-stopped
    env_file: .env
    command: >
      --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - internal_net

  # Backend Service (Flask + Gunicorn)
  backend:
    build:
      context: ./itsquizz-be_v2
      dockerfile: Dockerfile
    container_name: itsquizz-be
    restart: unless-stopped
    env_file: .env
    # ports:
    #   - "9002:5000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - SECRET_KEY=${SECRET_KEY}
      - SESSION_TYPE=${SESSION_TYPE}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - RUN_SEEDER=${RUN_SEEDER}
    volumes:
      - backend_uploads:/app/uploads
    depends_on:
      - db
    networks:
      - internal_net
      - web

  # Frontend Service (Nginx serving React)
  frontend:
    build:
      context: ./itsquizz-fe_v2
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL}
    container_name: itsquizz-fe
    restart: unless-stopped
    # ports:
    #   - "9001:80"
    #   - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      - backend
    networks:
      - internal_net
      - web

  # Certbot for SSL Certificates
  # certbot:
  #   image: certbot/certbot
  #   container_name: itsquizz-certbot
  #   volumes:
  #     - ./certs:/etc/letsencrypt
  #     - ./certbot/www:/var/www/certbot
  #   entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12d & wait $${!}; done;'"

volumes:
  mysql_data: null
  backend_uploads: null

networks:
  internal_net:
    driver: bridge
  public_net:
    driver: bridge
  web:
